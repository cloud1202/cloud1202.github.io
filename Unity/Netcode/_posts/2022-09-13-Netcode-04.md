---
layout: post
title: Unity Netcode 따라하기 Golden Path Two
tags: Unity Netcode Unet Network
date: 2022-09-13 16:00 +0900
category: Netcode
parent: Unity 
toc: true
---
## Golden Path Two
[Golden Path Two 학습 문서](https://docs-multiplayer.unity3d.com/netcode/current/tutorials/goldenpath_series/goldenpath_two)
본 게시글은 해당 문서를 학습하며 정리한 게시글 입니다.  

[Netcode 설치하기](/unity/netcode/2022/08/21/Netcode-01)  
해당 게시글에 **Netcode** 설치 및 프로젝트 생성까지 소개 한다.

[Hello World 학습하기](/unity/netcode/2022/08/21/Netcode-02)  
해당 게시글에 선행 프로젝트인 **Hello World** 학습 및 구현 한다.  

[Golden Path One 학습 문서](/unity/netcode/2022/09/60/Netcode-03)
해당 게시글은 **Golden Path One** 학습 정리글입니다.

*<strong>앞선 게시글 부터 순차적으로 진행하는 로드맵입니다 선행 프로젝트를 먼저 학습해 주세요.</strong>  

### Server에서 Network 변수 제어하기

Client에서 Server로 변수를 보내 중요 데이터 및 공유 데이터를 Server에서 제어하게끔 만들어야 하는 경우가 있다.  
해당 코드는 그러한 기능을 안내한다.  

위에 링크한 문서에는 빠트린게 몇몇가지가 있는 것 같다. 이것저것 찾아본 결과 다른 개발자도 이상하게 여기는 것을 보아 누락된 부분이 있는 것 같다.  
나도 그냥 넘어 갈까 했지만, 공부하는데 한번 누락된 부분을 추가해 보자 해서 추가된 코드가 있다.  
*<strong>추가된 코드는 주석으로 표시해두었다.</strong>

|**NetworkVariableTest.cs**|

```cs
using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using Unity.Netcode;
```
```cs
namespace HelloWorld // HelloWorld 관련 코드들을 묶어줬다.
{
    public class NetworkVariableTest : NetworkBehaviour
{
    private NetworkVariable<float> ServerNetworkVariable = new NetworkVariable<float>();
    // ClientNetworkVariable 변수 추가
    // public NetworkVariable<float> ClientNetworkVariable = new NetworkVariable<float>();
    private float last_t = 0.0f;

    public override void OnNetworkSpawn()
    {
        if(IsServer)
        {
            ServerNetworkVariable.Value = 0.0f;
            // 변수 초기화
            // ClientNetworkVariable.Value = 0.0f;
            Debug.Log("Server's var initialized to : " + ServerNetworkVariable.Value);
        }
    }

    // Update is called once per frame
    void Update()
    {
        var t_now = Time.time;
        if (IsServer)
        {
            ServerNetworkVariable.Value = ServerNetworkVariable.Value + 0.1f;
            if(t_now - last_t > 0.5f)
            {
                last_t = t_now;
                Debug.Log("Server set its var to: " + ServerNetworkVariable.Value + ", has client var at: " + ClientNetworkVariable.Value);
            }
        }
        else
        {
            // Server가 아닌경우 ServerRpc 메서드 호출
            this.SubmitNetworkVariableRequestServerRpc();
        }
    }

    [ServerRpc]
    void SubmitNetworkVariableRequestServerRpc(ServerRpcParams rpcParams = default)
    {
        // Client 변수에 값 추가.
        ClientNetworkVariable.Value = ClientNetworkVariable.Value + 0.1f;
    }
}
```

간단한 설명은 주석에 적어두었다.  

해당 코드를 Player Prefab에 추가해주고 Build 한뒤 Server와 Client로 실행하면 해당 결과가 나온다.
*<strong>Editor와 .exe 파일 간에는 값의 격차가 크다. 나는 .exe 파일로만 테스트 했다.</strong>  

|**실행결과**|  

```
UnloadTime: 0.673400 ms
Server's var initialized to : 0
Server set its var to: 0.1, has client var at: 0
Server set its var to: 2.999999, has client var at: 2.4
Server set its var to: 5.999997, has client var at: 5.399997
Server set its var to: 8.999998, has client var at: 8.399996
Server set its var to: 12.10001, has client var at: 11.50001
Server set its var to: 15.10002, has client var at: 14.50002
Server set its var to: 18.10003, has client var at: 17.50003
Server set its var to: 21.10004, has client var at: 20.50004
Server set its var to: 24.10006, has client var at: 23.50005
...
```
잘 나오는 것을 볼 수 있다. Debug.Log로 출력되는 Log는 따로 설정하지 않는 이상  
[C드라이브] - [Users] - [사용자 이름] - [Appdata] - [localNow] - [빌드시 설정한 회사이름] - [프로젝트 이름] 폴더에 들어가보면 txt 파일이 있을 것이다.  

#### OnNetworkSpawn() 메서드  

|**OnNetworkSpawn()**|  

```cs
public override void OnNetworkSpawn() // NetworkObject가 생성된 후 호출 된다.
{
    if (IsOwner) // 생성된 NetworkObject가 자신인지 아닌지 확인 후 다음 구문 실행
    {
       Move();
    }
}  
```
해당 메서드는 **NetworkBehaviour**에 선언된 메서드이다.  
주석에 적혀있듯이 **NetworkObject**가 생성된 후 호출되는 메서드인데, **조건문**이 있다.  
해당 **조건문**은 생성된 **NetworkObject**가 해당 클라이언트에서 생성된 **Object**인지 확인해준다.  
해당 **Property** 또한 **NetworkBehaviour**에 선언된 **Property**이다.  

해당 **조건문**이 있는 이유는 새로운 **NetworkObject**가 **생성**될 때 마다 **모든 클라이언트**에서 **OnNetworkSpawn()**가 **호출**되기 때문이다.  
조건문이 없었다면 **N번째 생성된 Player는 N번 움직이게 될 것이다.**(정말로 N번 움직이지는 않는다. **Server**에 **position** 값을 보내고 **Update()**문이 실행 되고 하는 사이에 간격의 차이로 한번만 움직인다.)  
**하지만 코드의 Move() 메서드가 N번 실행되는 것은 맞다.**  

내가 확인해본 방법은 생성한 **Client ID** 와 현재 **Client ID** 를 출력해 **비교**해 보는 방법이다.  

```cs
Move();
Debug.Log($"생성된 객체가 내거야? : {IsOwner}, 생성한 ClientID : {OwnerClientId}, 현재 ClientID : {NetworkManager.LocalClientId}");
``` 
**OnNetworkSpawn()** 메서드의 기존 내용을 주석 처리 한 뒤 해당 내용을 넣어 **Build**해준다.  
**Editor**와 **Build**된 실행파일을 실행해 테스트 해보면 아래와 같은 결과가 나온다.  

|**Host Log**|
|:---:|
|![Netcode_Log_Host](/assets/img/2022-09-02-Netcode-03/Netcode_Log_Host.png "Read Host Log")|  

|**Client Log**|
|:---:|
|![Netcode_Log_Client](/assets/img/2022-09-02-Netcode-03/Netcode_Log_Client.png "Read Client Log")|  

**Debug.Log**를 사용해 출력해 보면 두번째 **NetworkObject**가 생성될 때 호출된 클래스의 **OnNetworkSpawn()** 메서드가 각각 다른 것을 알 수 있다.  

**Build**된 **Debug.Log**를 확인하는 방법은 **[C드라이브] - [Users] - [사용자 이름] - [AppData] - [LocalLow] - [설정한 CompanyName]** 폴더에 있다.  
**(AppData 폴더는 숨김 폴더이므로 숨김폴더 해제 해야 한다.)**  

#### SubmitPositionRequestServerRpc() 메서드 

**Move()** 메서드와 **GetRandomPositionOnPlane()** 메서드는 따로 설명할 필요를 못 느껴 건너뛰었다.  

|**SubmitPositionRequestServerRpc()**|  

```cs
[ServerRpc]
void SubmitPositionRequestServerRpc(ServerRpcParams rpcParams = default)
{
    Position.Value = GetRandomPositionOnPlane();
}        
```

이 메서드는 **Netcode**에서 지원하는 속성인 **ServerRpc(Remote Prosedure Call)**을 부여한 메서드다.  
**Client**에서 **Server**로 **정보를 보낼 수 있으며**, **Client에서만 호출이 가능하다.**  
**Server에서만 호출이 가능한 ClientRpc 속성이 있다.**  
해당 속성을 사용하는 메서드는 반드시 이름의 마지막에 **ServerRpc**가 들어가거나, **[ServerRpc] 속성**을 할당해야 한다.  

해당 메서드는 **Server** 또는 **Host**에 동일 객체에 있는 동일한 이름의 메서드를 호출한다.  
즉, **Client**에서 해당 메서드를 호출하면  
**Server** 또는 **Host**에 존재하는 호출한 **NetworkObject**의 메서드가 실행 된다.  

### 프로그램 상태 설정하기(Server, Client, Host)

앞서 **cmd**로 계속해서 상태를 변경하느라 고생이었다..  
이제 프로그램 시작 시 상태를 설정할 수 있게 기능을 추가해 보자.  

지난번 만들었던 **[Scripts]** 폴더에 새로운 C# 파일을 생성한다.  
이름은 **HelloWorldManager**로 하였다.  

해당 코드는 아래와 같다.

기능은 앞서 말했듯이 **Server**, **Client**, **Host**로 상태를 설정해주는 기능과 **Player**가 생성된 후 **Move()** 메서드를 호출 할 수 있도록 UI를 추가해주는 기능이다.  

|**HelloWorldManager.cs**|

```cs
using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using Unity.Netcode;
```
```cs
namespace HelloWorld
{
    public class HelloWorldManager : MonoBehaviour
    {
        private void OnGUI() // UI를 코드로 만들어 프로그램 실행 시 띄어준다.
        {
            GUILayout.BeginArea(new Rect(10, 10, 300, 300));
            if (!NetworkManager.Singleton.IsClient && !NetworkManager.Singleton.IsServer) // 상태가 정해졌는지 조건문
            {
                StartButtons();
            }
            else
            {
                StatusLabels();

                SubmitNewPosition();
            }

            GUILayout.EndArea();
        }

        static void StartButtons()
        {
            if (GUILayout.Button("Host")) NetworkManager.Singleton.StartHost();
            if (GUILayout.Button("Server")) NetworkManager.Singleton.StartServer();
            if (GUILayout.Button("Client")) NetworkManager.Singleton.StartClient();
        }

        static void StatusLabels()
        {
            var mode = NetworkManager.Singleton.IsHost ?
                "Host" : NetworkManager.Singleton.IsServer ? "Server" : "Client";

            GUILayout.Label("Transport: " +
                NetworkManager.Singleton.NetworkConfig.NetworkTransport.GetType().Name);
            GUILayout.Label("Mode: " + mode);
        }

        static void SubmitNewPosition()
        {
            if(GUILayout.Button(NetworkManager.Singleton.IsServer ? "Move" : "Request Position Change"))
            {
                if(NetworkManager.Singleton.IsServer && !NetworkManager.Singleton.IsClient)
                {
                    // 서버에 접속한 클라이언트의 Player 전부 Move()메서드를 호출한다.
                    foreach (ulong uid in NetworkManager.Singleton.ConnectedClientsIds) 
                        NetworkManager.Singleton.SpawnManager.GetPlayerNetworkObject(uid).GetComponent<HelloWorldPlayer>().Move();
                }
                else
                {
                    var playerObject = NetworkManager.Singleton.SpawnManager.GetLocalPlayerObject();
                    var player = playerObject.GetComponent<HelloWorldPlayer>();
                    player.Move();
                }
            }
        }
    }
}
```  
현재는 잘 사용하지 않는 **OnGUI()**를 사용해서 구현한 **Management** 코드다.  
**UGUI**로 구현해도 상관 없다. 편한 방식을 사용하면 된다.  
해당 코드는 적혀 있는 주석만으로 추가 설명은 필요 없을 것 같다.  

참고로 **OnGUI()**를 사용해 만든 **UI**는 **Scene View**에서는 **볼 수 없다.**  

모든 준비가 끝났다! 혹시나 중간에 테스트하려고 추가 또는 수정한 코드가 이상하지 않은지 다시 확인해보고 **Build**를 진행한다.  

![Netcode_Result](/assets/img/2022-09-02-Netcode-03/Netcode_Result.png "Result Golden Path")